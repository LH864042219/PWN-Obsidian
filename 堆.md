堆（heap），pwn的一道分水岭，各种教程都会叽里呱啦说一堆东西和名词，一时半会还是看不懂，还是边做题边学。
# 基础概念
但话说回来，一些基础概念还是要知道的。
## 堆概述
首先，堆（Heap）是虚拟地址空间的一块连续的线性区域，提供动态分配的内存，允许程序申请大小未知的内存，它在用户与操作系统之间，作为动态内存管理的中间人。同时堆响应用户的申请内存请求，向操作系统申请内存，然后将其返回给用户程序，管理用户所释放的内存，并在合适的时候还给操作系统。
简单来说，堆主要是指用户动态申请的内存（如调用malloc、alloc、alloca、new等函数）。
目前有以下几种内存分配器：
- Dlmalloc-General purpose allocator
- **ptmalloc2-glibc** (重点)
- Jemalloc-Firefox    
- Tcmalloc-chrome   
- ...
CTF比赛中有关堆的PWN题大多是基于Linux的ptmalloc2-glibc堆块管理机制的。因此目前学的都是该管理器。
![[Pasted image 20250227153925.png]]
堆管理器并非由操作系统实现，而是由libc.so.6链接库实现。封装了一些系统调用，为用户提供方便的动态内存分配接口的同时，力求高效地管理由系统调用申请来的内存，申请内存的系统调用有brk和mmap两种。
1. brk是将数据段(.data)的最高地址指针_edata往高地址推。（_edata指向数据段的最高地址）
2. mmap是在进程的虚拟地址空间中（堆和栈中间，称为文件映射区域的地方）找一块空闲的虚拟内存。
这两种方式分配的都是虚拟内存，没有分配物理内存。在第一次访问已分配的虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，然后建立虚拟内存和物理内存之间的映射关系。malloc小于128k的内存时，glibc使用brk分配内存；大于128k时，使用mmap分配内存，在堆和栈之间找一块空闲内存分配。第一次执行malloc可能出现的系统调用如下。
![[Pasted image 20250227154039.png]]
## Arena
