这里很感谢两篇文章
第一篇环境搭建 []()
# 环境搭建
第一次遇到v8的题目，环境搭了好几天都快放弃了，最后还是找到问题了，必须说一下环境搭建的问题。
首先需要 depot_tools. 这个工具库是专门搞 Chromium 开发用的, 里面有一堆程序和脚本.
```shell
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
export PATH=/path/to/depot_tools:$PATH
```

接着 clone v8, 并且下载工具. 可以用 depot_tools 中的 `fetch`, 它会在当前目录下生成一些文件如 `.cipd`, `.gclient`, `.gclient_entries`, `.gclient_previous_sync_commits` clone 完成后进入 v8 目录, 使用 `gclient sync` 下载工具.
```shell
fetch v8
cd v8
```
接着，将git版本reset到与题目一致的版本
```shell
git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598  
git apply < oob.diff
```
**接下来，重要的一步**
```shell
gclient sync # 必须的一步，不然编译不了，我就是缺了这步搞了好几天没编译出来
./build/install-build-dep.sh # 这一步可能运行不了，ubuntu版本可能不支持，但好像也不影响
```
之后便可以开始编译
```shell
# 编译debug版本  
tools/dev/v8gen.py x64.debug  
ninja -C out.gn/x64.debug d8  
# 编译release版本  这样会支持release版本可以使用job等调试
tools/dev/gm.py x64.release  
ninja -C out/x64.release d8
```
编译完之后可以在out.gn/x64.release里面找到d8，然后就可以运行.js文件开始调试了

# 调试
## 自带工具
v8给出了自带的调试工具在tools文件夹里，需要在.gdbinit文件内`source`一下
```shell
vim ~/.gdbinit

source /your/path/to/v8/tools/gdbinit  
source /your/path/to/v8/tools/gdb-v8-support.py
```
## DCHECK
编译选项中默认`is_debug = true`会设置DCHECK宏，它负责一些简单的安全检查, 如判断数组是否越界. 而题目往往编译的 release 版本, 如果在利用中有这种行为, 不会有什么影响. 但是用 debug 版本调试时会直接 assert. 不幸的是没有选项能够取消设置 DCHECK. 如果还需要在 debug 版本下调试以获得良好体验的话, 可以手动 patch 一下. 在 `src/base/logging.h` 中找到 DCHECK 定义的地方:
```cpp
#ifdef DEBUG

#define DCHECK_WITH_MSG(condition, message)   \
  do {                                        \
    if (V8_UNLIKELY(!(condition))) {          \
      V8_Dcheck(__FILE__, __LINE__, message); \
    }                                         \
  } while (0)
#define DCHECK(condition) DCHECK_WITH_MSG(condition, #condition)
```
直接把`do while`中的代码删掉即可